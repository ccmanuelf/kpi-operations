name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4 # TODO: Pin to SHA for supply-chain security

      - uses: actions/setup-python@v5 # TODO: Pin to SHA for supply-chain security
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements-dev.txt

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Check code formatting
        run: black --check .

      - name: Run type checking
        run: mypy . --ignore-missing-imports --no-error-summary

      - name: Run linting
        run: flake8 . --count --show-source --statistics

      - name: Run tests with coverage
        run: PYTHONPATH=.. pytest tests/ --tb=short -q --cov=. --cov=auth --cov=cache --cov=tasks --cov=utils --cov=endpoints --cov-report=xml:coverage.xml --cov-report=html:htmlcov --cov-fail-under=75

      - name: Upload backend coverage
        if: always()
        uses: actions/upload-artifact@v4 # TODO: Pin to SHA for supply-chain security
        with:
          name: backend-coverage
          path: |
            backend/coverage.xml
            backend/htmlcov/
          retention-days: 14

      - name: Security scan
        run: bandit -r . -ll --exclude ./tests -q

      - name: Secret scanning
        run: |
          pip install detect-secrets
          detect-secrets scan --baseline .secrets.baseline || echo "No baseline found, scanning all files"
          detect-secrets scan --all-files --force-use-all-plugins 2>&1 | grep -c "True" && echo "::warning::Potential secrets detected" || echo "No secrets detected"

  frontend-lint-and-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4 # TODO: Pin to SHA for supply-chain security

      - uses: actions/setup-node@v4 # TODO: Pin to SHA for supply-chain security
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint -- --no-fix

      - name: Run unit tests with coverage
        run: npx vitest run --coverage

      - name: Upload frontend coverage
        if: always()
        uses: actions/upload-artifact@v4 # TODO: Pin to SHA for supply-chain security
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 14

      - name: Build frontend
        run: npm run build

      - name: Security audit
        run: npm audit --audit-level=high

  docker-build:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-lint-and-tests]
    steps:
      - uses: actions/checkout@v4 # TODO: Pin to SHA for supply-chain security

      - name: Build backend Docker image
        run: docker build -t kpi-operations-backend .

      - name: Build frontend Docker image
        run: docker build -t kpi-operations-frontend frontend/

      - name: Smoke test backend image
        run: |
          docker run -d --name backend-smoke -p 8000:8000 \
            -e DATABASE_URL=sqlite:///tmp/test.db \
            -e SECRET_KEY=ci-test-only \
            kpi-operations-backend
          sleep 5
          curl -f http://localhost:8000/health/live || (docker logs backend-smoke && exit 1)
          docker stop backend-smoke
          docker rm backend-smoke
